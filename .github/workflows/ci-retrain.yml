name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  WORKING_DIR: "MLProject"

jobs:
  retrain-and-build-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MLflow
        run: |
          python -m pip install --upgrade pip
          pip install "mlflow[extras]" mlserver mlserver-mlflow

      - name: Cache Conda packages (speed up mlflow run)
        uses: actions/cache@v3
        with:
          path: ~/conda_pkgs_dir
          key: conda-${{ runner.os }}-${{ hashFiles('**/conda.yaml') }}

      - name: Setup Conda cache directory
        run: |
          mkdir -p ~/conda_pkgs_dir
          echo "CONDA_PKGS_DIRS=~/conda_pkgs_dir" >> $GITHUB_ENV

      - name: Force Local MLflow Tracking
        run: |
          echo "MLFLOW_TRACKING_URI=file:./mlruns" >> $GITHUB_ENV

      - name: Verify Preprocessing File
        run: |
          cd ${{ env.WORKING_DIR }}
          if [ ! -f "data/preprocessing_objects.pkl" ]; then
            echo "ERROR: preprocessing_objects.pkl not found!"
            ls -la data/ || true
            exit 1
          fi
          echo "Preprocessing file found!"

      - name: Run Training using MLproject (Best Practice)
        run: |
          cd ${{ env.WORKING_DIR }}
          echo "Running project via MLproject â†’ conda env created automatically"

          mlflow run . \
            -P model_name=all \
            --experiment-name=Heart_Disease_Classification

      - name: Extract Latest Run ID & Best Model
        id: run_info
        run: |
          cd ${{ env.WORKING_DIR }}
          python - <<'PY'
          import mlflow, os
          client = mlflow.tracking.MlflowClient()
          exp = client.get_experiment_by_name("Heart_Disease_Classification")
          runs = client.search_runs(exp.experiment_id, order_by=["start_time DESC"], max_results=1)
          run = runs[0]
          run_id = run.info.run_id
          best_model = run.data.params.get("best_model_name", "Unknown")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"run_id={run_id}\n")
              f.write(f"best_model={best_model}\n")
          print(f"Run ID: {run_id} | Best Model: {best_model}")
          PY

      - name: Verify Best Model File
        run: |
          cd ${{ env.WORKING_DIR }}
          ls -lh data/best_model_*.pkl
          [ -f "data/best_model_${{ steps.run_info.outputs.best_model }}.pkl" ] && echo "Best model file OK"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          RUN_ID: ${{ steps.run_info.outputs.run_id }}
          BEST_MODEL: ${{ steps.run_info.outputs.best_model }}
        run: |
          cd ${{ env.WORKING_DIR }}
          IMAGE="$DOCKER_USER/heart-disease-model"

          export MLFLOW_TRACKING_URI=file:./mlruns

          if mlflow models build-docker \
               --model-uri "runs:/$RUN_ID/best_model" \
               --name "$IMAGE:latest" \
               --enable-mlserver; then
            echo "MLflow native Docker build succeeded"
          else
            echo "Fallback to manual Dockerfile"
            cat > Dockerfile <<EOF
          FROM python:3.12-slim
          RUN pip install --no-cache-dir mlserver==1.5.0 mlserver-mlflow==1.5.0 scikit-learn pandas numpy
          COPY data/best_model_${BEST_MODEL}.pkl /app/model.pkl
          COPY mlruns /app/mlruns
          WORKDIR /app
          ENV MLSERVER_MODEL_URI=/app/model.pkl
          ENV MLSERVER_MODEL_NAME=heart-disease
          EXPOSE 8080
          CMD ["mlserver", "start", "/app"]
          EOF
            docker build -t $IMAGE:latest .
          fi

          TAG=$(date +%Y%m%d-%H%M%S)
          docker tag $IMAGE:latest $IMAGE:$TAG
          docker tag $IMAGE:latest $IMAGE:${RUN_ID:0:8}

          docker push $IMAGE:latest
          docker push $IMAGE:$TAG
          docker push $IMAGE:${RUN_ID:0:8}

          echo "IMAGE_LATEST=$IMAGE:latest" >> $GITHUB_ENV
          echo "IMAGE_TAGGED=$IMAGE:$TAG" >> $GITHUB_ENV

      - name: Test Docker Image
        run: |
          docker run -d -p 5000:8080 --name test ${{ env.IMAGE_LATEST }}
          sleep 15
          curl -f http://localhost:5000/v2/models/heart-disease/ready && echo "Model ready!"
          docker stop test && docker rm test

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts
          path: |
            ${{ env.WORKING_DIR }}/csv_output/
            ${{ env.WORKING_DIR }}/data/best_model_*.pkl

      - name: Summary
        run: |
          echo "## CI/CD Success!" >> $GITHUB_STEP_SUMMARY
          echo "- Best Model: **${{ steps.run_info.outputs.best_model }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: \`${{ env.IMAGE_LATEST }}\`" >> $GITHUB_STEP_SUMMARY
