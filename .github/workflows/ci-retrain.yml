name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  WORKING_DIR: "MLProject"

jobs:
  retrain-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip + MLproject env
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .mlflow_venv_cache
          key: mlproject-${{ hashFiles('MLProject/requirements.txt') }}-${{ runner.os }}

      - name: Install MLflow
        run: pip install --upgrade pip "mlflow[extras]"

      - name: Force Local Tracking URI
        run: echo "MLFLOW_TRACKING_URI=file:./mlruns" >> $GITHUB_ENV

      - name: Verify Data File
        run: |
          cd ${{ env.WORKING_DIR }}
          ls -la data/
          [ -f "data/preprocessing_objects.pkl" ] || (echo "ERROR: preprocessing_objects.pkl missing!" && exit 1)

      - name: Run Training via MLproject (pip + venv â†’ 100% works on CI)
        run: |
          cd ${{ env.WORKING_DIR }}
          echo "Running MLproject with python_env (requirements.txt)"

          mlflow run . \
            -P model_name=all \
            --experiment-name=Heart_Disease_Classification \
            --env-manager=local   # penting: paksa local venv, bukan conda

      - name: Find Best Model File (Most Reliable Way)
        id: bestmodel
        run: |
          cd ${{ env.WORKING_DIR }}/data
          BEST_FILE=$(ls best_model_*.pkl | head -1)
          if [ -z "$BEST_FILE" ]; then
            echo "ERROR: No best_model_*.pkl found!"
            exit 1
          fi
          BEST_NAME=$(echo $BEST_FILE | sed 's/best_model_//' | sed 's/\.pkl$//')
          echo "Found best model: $BEST_NAME ($BEST_FILE)"
          echo "file=$BEST_FILE" >> $GITHUB_OUTPUT
          echo "name=$BEST_NAME" >> $GITHUB_OUTPUT

      - name: Build & Push Docker Image (Fallback Manual - 100% Reliable)
        env:
          IMAGE: ${{ secrets.DOCKER_USERNAME }}/heart-disease-model
          BEST_MODEL_FILE: ${{ steps.bestmodel.outputs.file }}
          BEST_MODEL_NAME: ${{ steps.bestmodel.outputs.name }}
        run: |
          cd ${{ env.WORKING_DIR }}

          echo "Using best model: $BEST_MODEL_NAME ($BEST_MODEL_FILE)"

          cat > Dockerfile <<EOF
          FROM python:3.12-slim
          WORKDIR /app

          RUN pip install --no-cache-dir \
              mlserver==1.5.0 \
              mlserver-mlflow==1.5.0 \
              scikit-learn pandas numpy

          # Copy model dan mlruns
          COPY $BEST_MODEL_FILE /app/model.pkl
          COPY mlruns /app/mlruns

          ENV MLSERVER_MODEL_URI=/app/model.pkl
          ENV MLSERVER_MODEL_NAME=heart-disease
          ENV MLSERVER_HTTP_PORT=8080

          EXPOSE 8080
          CMD ["mlserver", "start", "/app"]
          EOF

          docker build -t $IMAGE:latest .

          TAG=$(date +%Y%m%d%H%M)
          RUN_ID=$(ls mlruns/*/ | head -1 | cut -c1-8)

          docker tag $IMAGE:latest $IMAGE:$TAG
          docker tag $IMAGE:latest $IMAGE:$RUN_ID

          echo "Pushing Docker images..."
          docker push $IMAGE:latest
          docker push $IMAGE:$TAG
          docker push $IMAGE:$RUN_ID

          echo "IMAGE_LATEST=$IMAGE:latest" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE:$TAG" >> $GITHUB_ENV

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        env:
          IMAGE: ${{ secrets.DOCKER_USERNAME }}/heart-disease-model
          RUN_ID: ${{ steps.runinfo.outputs.run_id }}
          BEST: ${{ steps.runinfo.outputs.best_model }}
        run: |
          cd ${{ env.WORKING_DIR }}
          export MLFLOW_TRACKING_URI=file:./mlruns

          if mlflow models build-docker \
               -m "runs:/$RUN_ID/best_model" \
               -n "$IMAGE:latest" \
               --enable-mlserver; then
            echo "MLflow native build OK"
          else
            echo "Fallback manual Dockerfile"
            cat > Dockerfile <<EOF
          FROM python:3.12-slim
          RUN pip install --no-cache-dir mlserver mlserver-mlflow scikit-learn pandas numpy
          COPY data/best_model_${BEST}.pkl /app/model.pkl
          COPY mlruns /app/mlruns
          WORKDIR /app
          ENV MLSERVER_MODEL_URI=/app/model.pkl
          ENV MLSERVER_MODEL_NAME=heart-disease
          EXPOSE 8080
          CMD ["mlserver", "start", "/app"]
          EOF
            docker build -t $IMAGE:latest .
          fi

          TAG=$(date +%Y%m%d%H%M)
          docker tag $IMAGE:latest $IMAGE:$TAG
          docker tag $IMAGE:latest $IMAGE:${RUN_ID:0:8}

          docker push $IMAGE:latest
          docker push $IMAGE:$TAG
          docker push $IMAGE:${RUN_ID:0:8}

          echo "IMAGE_LATEST=$IMAGE:latest" >> $GITHUB_ENV

      - name: Test Image
        run: |
          docker run -d -p 5000:8080 --name test ${{ env.IMAGE_LATEST }}
          sleep 15
          curl -f http://localhost:5000/ping || echo "Warning: ping not available (normal for MLServer)"
          docker logs test
          docker stop test && docker rm test

      - name: Summary
        run: |
          echo "## CI/CD Pipeline Berhasil!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Best Model: **${{ steps.bestmodel.outputs.name }}**" >> $GITHUB_STEP_SUMMARY
          echo "Docker Image: \`${{ env.IMAGE_LATEST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8080:8080 ${{ env.IMAGE_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
